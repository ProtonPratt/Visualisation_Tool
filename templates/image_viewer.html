<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Viewer with Bounding Boxes</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="sidebar">
        <h2>Sort Images</h2>
        <label for="sort-dropdown">Sort by:</label>
        <form id="sort-form" method="GET">
            <select id="sort-dropdown" name="metric" onchange="updateSort()">
                <option value="none" {% if metric == 'none' %}selected{% endif %}>None</option>
                <option value="recall" {% if metric == 'recall' %}selected{% endif %}>Recall</option>
                <option value="precision" {% if metric == 'precision' %}selected{% endif %}>Precision</option>
                <option value="miou" {% if metric == 'miou' %}selected{% endif %}>mIoU</option>
            </select>
            <input type="hidden" name="index" value="{{ index }}">
            <input type="hidden" name="mode" value="{{ view_mode }}">
        </form>
    </div>
    <div class="container">
        <!-- Main Heading -->
        <div class="row">
            <div class="col text-center">
                <h1 class="text-center">Image Viewer</h1>
            </div>
        </div>

        <!-- Dropdown to select image -->
        <div class="row">
            <div class="col text-center">
                <label for="image-dropdown">Select an image:</label>
                <form id="image-selector-form" method="GET">
                    <select id="image-dropdown" name="index" onchange="updateImage()">
                        {% for idx in range(total_images) %}
                            <option value="{{ idx }}" {% if idx == index %}selected{% endif %}>
                                {{ idx + 1 }}:{{image_names[idx]}}
                            </option>
                        {% endfor %}
                    </select>
                </form>
            </div>
        </div>

        <!-- Dropdown to select view mode -->
        <div class="text-center mb-3">
            <form id="view-mode-form" method="GET">
                <label for="view-mode-dropdown">View mode:</label>
                <select id="view-mode-dropdown" name="mode" onchange="submitViewModeForm()">
                    <option value="original" {% if view_mode == 'original' %}selected{% endif %}>Original</option>
                    <option value="predicted" {% if view_mode == 'predicted' %}selected{% endif %}>Predicted</option>
                    <option value="gt" {% if view_mode == 'gt' %}selected{% endif %}>GroundTruth</option>
                    <option value="both" {% if view_mode == 'both' %}selected{% endif %}>GT+predicted</option>
                </select>
            </form>
        </div>

        <!-- Display Recall, Precision, and mIoU -->
        <div class="row">
            <div class="col text-center">
                <div class="image-info">
                    <p><strong>Recall:</strong> {{ recall }}</p>
                    <p><strong>Precision:</strong> {{ precision }}</p>
                    <p><strong>mIoU:</strong> {{ miou }}</p>
                </div>
            </div>
        </div>

        <!-- Image with Bounding Boxes -->
        <div class="row">
            <div class="col text-center">
                <div class="image-container" id="image-container">
                    <img id="selected-image" src="{{ url_for('get_processed_image', index=index, mode=view_mode) }}" class="img-fluid" alt="Image">
                    <div class="zoom-controls">
                        <label for="zoom-slider">Zoom Level:</label>
                        <input type="range" id="zoom-slider" min="1" max="5" step="0.1" value="1" onchange="updateZoom()">
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="row mt-3">
            <div class="col text-left">
                <a href="{{ url_for('view_image', index=prev_index, mode=view_mode, metric=metric) }}" class="btn btn-primary">Previous</a>
            </div>
            <div class="col text-right">
                <a href="{{ url_for('view_image', index=next_index, mode=view_mode, metric=metric) }}" class="btn btn-primary">Next</a>
            </div>
        </div>
    </div>
    <script>
        function updateImage() {
            var form = document.getElementById('image-selector-form');
            console.log(form.action);
            // form.action = "{{ url_for('view_image', index=prev_index, mode=mode, metric=metric) }}".replace('prev_index', form.elements['index'].value);
            var newIndex = form.elements['index'].value;
            var mode = "{{ mode }}";  // Ensure these are properly set in your template
            var metric = "{{ metric }}";
            
            // Construct the URL correctly
            form.action = `/image/${newIndex}?mode=${mode}&metric=${metric}`;
            form.submit();
        }
        function submitViewModeForm() {
            var form = document.getElementById('view-mode-form');
            form.action = "{{ url_for('view_image', index=index, mode=newmode, metric=metric) }}".replace('newmode', form.elements['mode'].value);
            form.submit();
        }
        function updateZoom() {
            var slider = document.getElementById('zoom-slider');
            var zoomFactor = slider.value;

            var imageContainer = document.getElementById('image-container');
            imageContainer.style.setProperty('--zoom-factor', zoomFactor);
            imageContainer.classList.add('zoomed');
        }
        function updateSort() {
            var form = document.getElementById('sort-form');
            form.action = "{{ url_for('view_image', index=index, mode=mode, metric=newmetric) }}".replace('newmetric', form.elements['mode'].value);
            form.submit();
        }
        
    </script>
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
</body>
</html>
